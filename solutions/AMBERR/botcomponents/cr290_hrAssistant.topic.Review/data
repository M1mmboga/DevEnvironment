kind: AdaptiveDialog
beginDialog:
  kind: OnRecognizedIntent
  id: main
  priority: -1
  intent:
    triggerQueries:
      - power platform environment
      - environments

  actions:
    - kind: SearchAndSummarizeContent
      id: search-content
      latencyMessageSettings:
        allowLatencyMessage: false

      autoSend: false
      variable: Topic.Answer
      userInput: =System.Activity.Text
      additionalInstructions: Keep answers very short, less then 25 words.
      fileSearchDataSource:
        searchFilesMode:
          kind: SearchSpecificFiles
          files:
            - cr290_hrAssistant.component.Module3-PowerPlatformEnvironments.pptx_8fM

      knowledgeSources:
        kind: SearchSpecificKnowledgeSources

      responseCaptureType: FullResponse

    - kind: ConditionGroup
      id: has-answer-conditions
      conditions:
        - id: has-answer
          condition: =!IsBlank(Topic.Answer)
          actions:
            - kind: SetVariable
              id: setVariable_LKxsRA
              variable: Topic.FilesSources
              value: |-
                =[
                    {
                        FileName: "Module 3 - Power Platform Environments.pptx",
                        FileUrl: "https://m365cpi22829036.sharepoint.com/sites/ExpertCorner/Shared%20Documents/Module%203%20-%20Power%20Platform%20Environments.pptx"
                    }
                ]

            - kind: SetVariable
              id: setVariable_ypg23P
              variable: Topic.UploadedFilesRootUrl
              value: https://m365cpi22829036.sharepoint.com/sites/ExpertCorner/Shared%20Documents/Module%203%20-%20Power%20Platform%20Environments.pptx

            - kind: SetVariable
              id: setVariable_eWQVoG
              variable: Topic.FormattedAnswer
              value: |-
                =// Combine content with citations
                Topic.Answer.Text.Content & Char(10) & Char(10) & 
                
                // Concatenate citations in Markdown format
                Concat(
                    Topic.Answer.Text.CitationSources,
                    
                    // Recreate the Url if there isn't one
                    "[" & Id & "]: " & 
                    If(
                        // If there is no URL
                        IsBlank(Url),
                        If(
                            // Check if the file exists in the FilesSources table
                            IsBlank(
                                LookUp(Topic.FilesSources, Name = FileName, ThisRecord)
                            ), 
                            // If doesn't exist, use the UploadedFilesRootUrl URL pattern
                            Topic.UploadedFilesRootUrl & Name,
                            // Else use the FilesSources table URL
                            LookUp(Topic.FilesSources, Name = FileName, FileUrl)
                        ), 
                        // Else used the returned URL Value.
                        Url
                    ) &
                
                    // Improve file name formatting
                    " """ & Substitute(Name, "%20", " ") & """",
                    
                    // Line breaks between citations
                    Char(10) & Char(10)
                )

            - kind: SendActivity
              id: sendActivity_skwikk
              activity: "{Topic.FormattedAnswer}"

            - kind: EndDialog
              id: end-topic
              clearTopicQueue: true